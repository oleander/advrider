FROM rustlang/rust:nightly-bookworm AS builder

ENV CARGO_TARGET_DIR=/cache \
    PATH=/root/.cargo/bin:$PATH \
    USER=root

WORKDIR /rust

RUN git clone https://github.com/trouchet/rust-hello.git .
COPY Cargo.* .
RUN cargo fetch
RUN cargo build
RUN rm -rf /rust

WORKDIR /app
COPY . .
RUN cargo build

EXPOSE 4040
HEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:4040/health || exit 1

CMD ["cargo", "run", "--bin", "scraper"]
